---
import Layout from "../../layouts/Layout.astro";
import { findPurchaseByToken, updatePurchase } from "../../lib/purchases";
import { verifyDownloadSignature } from "../../lib/downloads";
import fs from 'fs/promises';
import path from 'path';

const { token } = Astro.params;
const url = new URL(Astro.request.url);
const timestamp = url.searchParams.get('t');
const signature = url.searchParams.get('s');

let purchase = null;
let error = null;
let downloadUrl = null;

if (!token || !timestamp || !signature) {
  error = "Invalid download link";
} else {
  // Verify the download signature
  if (!verifyDownloadSignature(token, timestamp, signature)) {
    error = "Download link has expired or is invalid";
  } else {
    // Find the purchase
    purchase = await findPurchaseByToken(token);
    
    if (!purchase) {
      error = "Purchase not found";
    } else if (new Date() > new Date(purchase.expiresAt)) {
      error = "Download link has expired";
    } else if (purchase.downloadCount >= purchase.maxDownloads) {
      error = "Maximum downloads exceeded";
    } else {
      // Check if file exists
      const fileName = purchase.productName.toLowerCase()
        .replace(/[^a-z0-9]/g, '-')
        .replace(/-+/g, '-')
        .replace(/^-|-$/g, '') + '.pdf';
      
      const filePath = path.join(process.cwd(), 'public', 'downloads', fileName);
      
      try {
        await fs.access(filePath);
        downloadUrl = `/downloads/${fileName}`;
        
        // Increment download count
        await updatePurchase(token, {
          downloadCount: purchase.downloadCount + 1
        });
      } catch {
        error = "File not found";
      }
    }
  }
}

const pageTitle = purchase ? `Download ${purchase.productName}` : "Download";
---

<Layout title={pageTitle}>
  <div class="max-w-2xl mx-auto py-12">
    {error ? (
      <div class="bg-red-100 rounded-2xl p-8 text-center">
        <div class="text-6xl mb-4">‚ùå</div>
        <h1 class="text-3xl font-bold text-red-800 mb-4">Download Error</h1>
        <p class="text-lg text-red-700 mb-6">{error}</p>
        <a 
          href="/contact" 
          class="inline-block bg-brand-primary hover:bg-brand-secondary text-white px-6 py-3 rounded-full"
        >
          Contact Support
        </a>
      </div>
    ) : purchase && downloadUrl ? (
      <div class="space-y-8">
        <div class="bg-green-100 rounded-2xl p-8 text-center">
          <div class="text-6xl mb-4">üìÑ</div>
          <h1 class="text-3xl font-bold text-green-800 mb-4">Ready to Download</h1>
          <p class="text-lg text-green-700">
            Your sheet music for "{purchase.productName}" is ready!
          </p>
        </div>

        <div class="bg-orange-100 rounded-2xl p-6">
          <h2 class="text-xl font-bold mb-4">Download Information</h2>
          <div class="space-y-2 text-sm">
            <p><strong>Product:</strong> {purchase.productName}</p>
            <p><strong>Purchase Date:</strong> {new Date(purchase.purchaseDate).toLocaleDateString()}</p>
            <p><strong>Downloads Used:</strong> {purchase.downloadCount + 1} of {purchase.maxDownloads}</p>
            <p><strong>Expires:</strong> {new Date(purchase.expiresAt).toLocaleDateString()}</p>
          </div>
        </div>

        <div class="text-center">
          <a 
            href={downloadUrl}
            download
            class="inline-block bg-brand-accent hover:bg-brand-accent2 text-white px-8 py-4 rounded-full text-xl font-bold"
          >
            Download PDF
          </a>
        </div>

        <div class="bg-gray-100 rounded-lg p-4">
          <h3 class="font-bold mb-2">Download Tips:</h3>
          <ul class="text-sm space-y-1 list-disc list-inside">
            <li>Right-click and "Save As" to save to your computer</li>
            <li>You can download this file {purchase.maxDownloads - purchase.downloadCount - 1} more times</li>
            <li>Print as many copies as you need for personal use</li>
            <li>Contact us if you have any issues with your download</li>
          </ul>
        </div>
      </div>
    ) : (
      <div class="bg-gray-100 rounded-2xl p-8 text-center">
        <div class="text-6xl mb-4">‚è≥</div>
        <h1 class="text-3xl font-bold mb-4">Processing...</h1>
        <p class="text-lg">Please wait while we prepare your download.</p>
      </div>
    )}
  </div>
</Layout>