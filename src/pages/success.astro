---
import Layout from "../layouts/Layout.astro";
const pageTitle = "Purchase Complete";
---

<Layout title={pageTitle}>
  <div class="max-w-2xl mx-auto text-center py-12">
    <div class="bg-green-100 rounded-2xl p-8 mb-8">
      <div class="text-6xl mb-4">âœ…</div>
      <h1 class="text-3xl font-bold text-green-800 mb-4">Purchase Complete!</h1>
      <p class="text-lg text-green-700">
        Thank you for your purchase.
      </p>
    </div>

    <!-- Loading state -->
    <div id="loading-state" class="bg-blue-100 rounded-2xl p-6 mb-8">
      <div class="flex items-center justify-center space-x-3">
        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-brand-primary"></div>
        <p class="text-lg font-semibold">Preparing your download...</p>
      </div>
      <p class="text-sm text-gray-600 mt-2">This usually takes just a few seconds</p>
    </div>

    <!-- Download ready state (hidden initially) -->
    <div id="download-ready" class="bg-green-50 rounded-2xl p-8 mb-8 hidden">
      <h2 class="text-2xl font-bold mb-4">Your Download is Ready!</h2>
      <p class="text-gray-700 mb-6" id="product-name"></p>

      <a
        id="download-button"
        href="#"
        class="inline-block bg-brand-primary hover:bg-brand-secondary text-white px-8 py-4 rounded-full font-bold text-lg transition-colors"
      >
        Download PDF
      </a>

      <div class="mt-6 text-sm text-gray-600">
        <p>Downloads remaining: <span id="downloads-remaining" class="font-semibold"></span></p>
        <p>Link expires: <span id="expires-at" class="font-semibold"></span></p>
      </div>
    </div>

    <!-- Error state (hidden initially) -->
    <div id="error-state" class="bg-red-100 rounded-2xl p-6 mb-8 hidden">
      <h2 class="text-xl font-bold text-red-800 mb-2">Something went wrong</h2>
      <p class="text-red-700" id="error-message"></p>
    </div>

    <div class="bg-gray-100 rounded-lg p-4 mb-8">
      <p class="text-sm text-gray-600">
        Order ID: <code class="bg-white px-2 py-1 rounded" id="session-id">Processing...</code>
      </p>
    </div>

    <div class="space-y-4">
      <div class="space-x-4">
        <a
          href="/songs"
          class="inline-block bg-brand-primary hover:bg-brand-secondary text-white px-6 py-3 rounded-full"
        >
          Back to Songs
        </a>
        <a
          href="/contact"
          class="inline-block bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-full"
        >
          Contact Us
        </a>
      </div>
    </div>
  </div>

  <script>
    // Get session_id from URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const sessionId = urlParams.get('session_id');
    const sessionIdElement = document.getElementById('session-id');

    // UI elements
    const loadingState = document.getElementById('loading-state');
    const downloadReady = document.getElementById('download-ready');
    const errorState = document.getElementById('error-state');
    const downloadButton = document.getElementById('download-button');
    const productName = document.getElementById('product-name');
    const downloadsRemaining = document.getElementById('downloads-remaining');
    const expiresAt = document.getElementById('expires-at');
    const errorMessage = document.getElementById('error-message');

    if (sessionId && sessionIdElement) {
      sessionIdElement.textContent = sessionId;

      // Start polling for purchase
      let pollAttempts = 0;
      const maxAttempts = 30; // Poll for up to 1 minute (2 second intervals)

      const pollPurchase = async () => {
        try {
          const response = await fetch(`/api/purchases/${sessionId}`);
          const data = await response.json();

          if (data.found) {
            // Purchase is ready!
            if (loadingState) loadingState.classList.add('hidden');

            if (data.isExpired) {
              if (errorState && errorMessage) {
                errorState.classList.remove('hidden');
                errorMessage.textContent = 'This download link has expired (valid for 7 days).';
              }
            } else if (data.downloadsExhausted) {
              if (errorState && errorMessage) {
                errorState.classList.remove('hidden');
                errorMessage.textContent = 'Download limit reached (maximum 5 downloads).';
              }
            } else {
              // Show download button
              if (downloadReady && downloadButton && productName && downloadsRemaining && expiresAt) {
                downloadReady.classList.remove('hidden');
                downloadButton.href = `/api/download/${data.downloadToken}`;
                productName.textContent = data.productName;
                downloadsRemaining.textContent = `${data.maxDownloads - data.downloadCount} of ${data.maxDownloads}`;

                const expiryDate = new Date(data.expiresAt);
                expiresAt.textContent = expiryDate.toLocaleDateString();
              }
            }
          } else {
            // Not found yet, keep polling
            pollAttempts++;
            if (pollAttempts < maxAttempts) {
              setTimeout(pollPurchase, 2000); // Poll every 2 seconds
            } else {
              // Max attempts reached
              if (loadingState) loadingState.classList.add('hidden');
              if (errorState && errorMessage) {
                errorState.classList.remove('hidden');
                errorMessage.textContent = 'Purchase processing is taking longer than expected. Please contact us with your Order ID.';
              }
            }
          }
        } catch (error) {
          console.error('Error checking purchase:', error);
          pollAttempts++;
          if (pollAttempts < maxAttempts) {
            setTimeout(pollPurchase, 2000);
          } else {
            if (loadingState) loadingState.classList.add('hidden');
            if (errorState && errorMessage) {
              errorState.classList.remove('hidden');
              errorMessage.textContent = 'Unable to load your download. Please contact us with your Order ID.';
            }
          }
        }
      };

      // Start polling
      pollPurchase();
    } else {
      if (sessionIdElement) {
        sessionIdElement.textContent = 'Not available';
      }
      if (loadingState) loadingState.classList.add('hidden');
      if (errorState && errorMessage) {
        errorState.classList.remove('hidden');
        errorMessage.textContent = 'No order information found. Please check your purchase confirmation email.';
      }
    }
  </script>
</Layout>